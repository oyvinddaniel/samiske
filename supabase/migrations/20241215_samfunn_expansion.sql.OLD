-- Samfunn System Expansion
-- Flerspråklige bransjer, platform admins, og utvidede community-funksjoner

-- ============================================
-- 1. INDUSTRIES TABLE (Bransjer)
-- ============================================

CREATE TABLE IF NOT EXISTS industries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,

  -- Flerspråklige navn
  name_no TEXT NOT NULL,              -- Norsk (påkrevd)
  name_sma TEXT,                       -- Sørsamisk
  name_sju TEXT,                       -- Umesamisk
  name_sje TEXT,                       -- Pitesamisk
  name_smj TEXT,                       -- Lulesamisk
  name_se TEXT,                        -- Nordsamisk

  created_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- Moderering
  is_approved BOOLEAN DEFAULT FALSE,
  approved_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  approved_at TIMESTAMP WITH TIME ZONE,

  is_active BOOLEAN DEFAULT TRUE
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_industries_slug ON industries(slug);
CREATE INDEX IF NOT EXISTS idx_industries_approved ON industries(is_approved, is_active);
CREATE INDEX IF NOT EXISTS idx_industries_created_at ON industries(created_at DESC);

-- Enable RLS
ALTER TABLE industries ENABLE ROW LEVEL SECURITY;

-- RLS Policies for industries
DROP POLICY IF EXISTS "Industries are viewable by everyone" ON industries;
CREATE POLICY "Industries are viewable by everyone" ON industries
  FOR SELECT USING (is_approved = TRUE AND is_active = TRUE);

DROP POLICY IF EXISTS "Authenticated users can suggest industries" ON industries;
CREATE POLICY "Authenticated users can suggest industries" ON industries
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

-- Platform admins can manage industries (will be created after platform_admins table)

-- Trigger for updated_at
DROP TRIGGER IF EXISTS trigger_update_industries_updated_at ON industries;
CREATE TRIGGER trigger_update_industries_updated_at
  BEFORE UPDATE ON industries
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 2. COMMUNITY_INDUSTRIES JUNCTION TABLE
-- ============================================

CREATE TABLE IF NOT EXISTS community_industries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE CASCADE,
  industry_id UUID NOT NULL REFERENCES industries(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(community_id, industry_id)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_community_industries_community ON community_industries(community_id);
CREATE INDEX IF NOT EXISTS idx_community_industries_industry ON community_industries(industry_id);

-- Enable RLS
ALTER TABLE community_industries ENABLE ROW LEVEL SECURITY;

-- RLS Policies
DROP POLICY IF EXISTS "Community industries are viewable by everyone" ON community_industries;
CREATE POLICY "Community industries are viewable by everyone" ON community_industries
  FOR SELECT USING (TRUE);

DROP POLICY IF EXISTS "Community admins can manage industries" ON community_industries;
CREATE POLICY "Community admins can manage industries" ON community_industries
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM community_admins
      WHERE community_admins.community_id = community_industries.community_id
      AND community_admins.user_id = auth.uid()
    )
  );

-- ============================================
-- 3. PLATFORM_ADMINS TABLE
-- ============================================

CREATE TABLE IF NOT EXISTS platform_admins (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  role TEXT CHECK (role IN ('owner', 'admin')) DEFAULT 'admin',

  created_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  is_active BOOLEAN DEFAULT TRUE,

  UNIQUE(user_id)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_platform_admins_user ON platform_admins(user_id);
CREATE INDEX IF NOT EXISTS idx_platform_admins_active ON platform_admins(is_active);
CREATE INDEX IF NOT EXISTS idx_platform_admins_role ON platform_admins(role);

-- Enable RLS
ALTER TABLE platform_admins ENABLE ROW LEVEL SECURITY;

-- RLS Policies
DROP POLICY IF EXISTS "Platform admins are viewable" ON platform_admins;
CREATE POLICY "Platform admins are viewable" ON platform_admins
  FOR SELECT USING (is_active = TRUE);

DROP POLICY IF EXISTS "Only owner can manage platform admins" ON platform_admins;
CREATE POLICY "Only owner can manage platform admins" ON platform_admins
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM platform_admins pa
      WHERE pa.user_id = auth.uid()
      AND pa.role = 'owner'
      AND pa.is_active = TRUE
    )
  );

-- Trigger to prevent owner deletion
CREATE OR REPLACE FUNCTION prevent_owner_deletion()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.role = 'owner' THEN
    RAISE EXCEPTION 'Cannot delete platform owner';
  END IF;
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS prevent_owner_deletion_trigger ON platform_admins;
CREATE TRIGGER prevent_owner_deletion_trigger
  BEFORE DELETE ON platform_admins
  FOR EACH ROW
  EXECUTE FUNCTION prevent_owner_deletion();

-- Trigger to prevent owner role change
CREATE OR REPLACE FUNCTION prevent_owner_role_change()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.role = 'owner' AND NEW.role != 'owner' THEN
    RAISE EXCEPTION 'Cannot change owner role';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS prevent_owner_role_change_trigger ON platform_admins;
CREATE TRIGGER prevent_owner_role_change_trigger
  BEFORE UPDATE ON platform_admins
  FOR EACH ROW
  EXECUTE FUNCTION prevent_owner_role_change();

-- ============================================
-- 4. UPDATE EXISTING TABLES
-- ============================================

-- Update COMMUNITIES table
DO $$
BEGIN
  -- Add address column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'communities' AND column_name = 'address'
  ) THEN
    ALTER TABLE communities ADD COLUMN address TEXT;
  END IF;

  -- Add phone column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'communities' AND column_name = 'phone'
  ) THEN
    ALTER TABLE communities ADD COLUMN phone TEXT;
  END IF;

  -- Add images column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'communities' AND column_name = 'images'
  ) THEN
    ALTER TABLE communities ADD COLUMN images JSONB DEFAULT '[]'::jsonb;
  END IF;
END $$;

-- Update PRODUCTS table
DO $$
BEGIN
  -- Add search_tags column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'products' AND column_name = 'search_tags'
  ) THEN
    ALTER TABLE products ADD COLUMN search_tags TEXT[] DEFAULT ARRAY[]::TEXT[];
  END IF;

  -- Add size column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'products' AND column_name = 'size'
  ) THEN
    ALTER TABLE products ADD COLUMN size TEXT;
  END IF;

  -- Drop category column if it exists (moving to industries system)
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'products' AND column_name = 'category'
  ) THEN
    ALTER TABLE products DROP COLUMN category;
  END IF;
END $$;

-- Create GIN index for search_tags on products
DROP INDEX IF EXISTS idx_products_search_tags;
CREATE INDEX idx_products_search_tags ON products USING gin(search_tags);

-- Update SERVICES table
DO $$
BEGIN
  -- Add search_tags column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'search_tags'
  ) THEN
    ALTER TABLE services ADD COLUMN search_tags TEXT[] DEFAULT ARRAY[]::TEXT[];
  END IF;

  -- Add booking_url column if it doesn't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'booking_url'
  ) THEN
    ALTER TABLE services ADD COLUMN booking_url TEXT;
  END IF;

  -- Update price_type check constraint if needed
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'price_type'
  ) THEN
    -- Drop old constraint if exists
    ALTER TABLE services DROP CONSTRAINT IF EXISTS services_price_type_check;
    -- Add new constraint with 'hourly' option
    ALTER TABLE services ADD CONSTRAINT services_price_type_check
      CHECK (price_type IN ('fixed', 'from', 'hourly', 'contact'));
  ELSE
    -- Add column with constraint
    ALTER TABLE services ADD COLUMN price_type TEXT DEFAULT 'contact'
      CHECK (price_type IN ('fixed', 'from', 'hourly', 'contact'));
  END IF;

  -- Add price and currency columns if they don't exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'price'
  ) THEN
    ALTER TABLE services ADD COLUMN price DECIMAL(10,2);
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'currency'
  ) THEN
    ALTER TABLE services ADD COLUMN currency TEXT DEFAULT 'NOK';
  END IF;

  -- Drop category column if it exists (moving to industries system)
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'services' AND column_name = 'category'
  ) THEN
    ALTER TABLE services DROP COLUMN category;
  END IF;
END $$;

-- Create GIN index for search_tags on services
DROP INDEX IF EXISTS idx_services_search_tags;
CREATE INDEX idx_services_search_tags ON services USING gin(search_tags);

-- ============================================
-- 5. UPDATE RLS POLICIES FOR INDUSTRIES (now that platform_admins exists)
-- ============================================

DROP POLICY IF EXISTS "Platform admins can manage industries" ON industries;
CREATE POLICY "Platform admins can manage industries" ON industries
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM platform_admins
      WHERE user_id = auth.uid() AND is_active = TRUE
    )
  );

DROP POLICY IF EXISTS "Platform admins can delete industries" ON industries;
CREATE POLICY "Platform admins can delete industries" ON industries
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM platform_admins
      WHERE user_id = auth.uid() AND is_active = TRUE
    )
  );

-- ============================================
-- 6. SEED INITIAL INDUSTRIES (Bransjer)
-- ============================================

-- Function to generate slug from Norwegian name
CREATE OR REPLACE FUNCTION generate_industry_slug(name TEXT)
RETURNS TEXT AS $$
BEGIN
  RETURN lower(
    regexp_replace(
      regexp_replace(
        regexp_replace(
          regexp_replace(name, '[æÆ]', 'ae', 'g'),
          '[øØ]', 'o', 'g'
        ),
        '[åÅ]', 'a', 'g'
      ),
      '[^a-z0-9]+', '-', 'g'
    )
  );
END;
$$ LANGUAGE plpgsql;

-- Insert initial industries (auto-approved)
INSERT INTO industries (slug, name_no, is_approved, is_active)
VALUES
  (generate_industry_slug('Museum'), 'Museum', TRUE, TRUE),
  (generate_industry_slug('Artist & joik'), 'Artist & joik', TRUE, TRUE),
  (generate_industry_slug('Reinkjøtt (salg)'), 'Reinkjøtt (salg)', TRUE, TRUE),
  (generate_industry_slug('Håndverk'), 'Håndverk', TRUE, TRUE),
  (generate_industry_slug('Opplevelser'), 'Opplevelser', TRUE, TRUE),
  (generate_industry_slug('Turarrangør'), 'Turarrangør', TRUE, TRUE),
  (generate_industry_slug('Foredragsholder'), 'Foredragsholder', TRUE, TRUE),
  (generate_industry_slug('Forfatter'), 'Forfatter', TRUE, TRUE),
  (generate_industry_slug('Oversetter'), 'Oversetter', TRUE, TRUE),
  (generate_industry_slug('Kunstner'), 'Kunstner', TRUE, TRUE)
ON CONFLICT (slug) DO NOTHING;

-- ============================================
-- 7. HELPER FUNCTIONS
-- ============================================

-- Function to check if user is platform admin
CREATE OR REPLACE FUNCTION is_platform_admin(user_id_param UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM platform_admins
    WHERE user_id = user_id_param
    AND is_active = TRUE
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get user's platform admin role
CREATE OR REPLACE FUNCTION get_platform_admin_role(user_id_param UUID)
RETURNS TEXT AS $$
DECLARE
  admin_role TEXT;
BEGIN
  SELECT role INTO admin_role
  FROM platform_admins
  WHERE user_id = user_id_param
  AND is_active = TRUE;

  RETURN admin_role;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 8. COMMENTS FOR DOCUMENTATION
-- ============================================

COMMENT ON TABLE industries IS 'Flerspråklige bransjer for samfunn-kategorisering';
COMMENT ON TABLE community_industries IS 'Kobling mellom communities og industries';
COMMENT ON TABLE platform_admins IS 'Platform administratorer med owner/admin roller';

COMMENT ON COLUMN industries.name_no IS 'Norsk navn (påkrevd)';
COMMENT ON COLUMN industries.name_sma IS 'Sørsamisk navn';
COMMENT ON COLUMN industries.name_sju IS 'Umesamisk navn';
COMMENT ON COLUMN industries.name_sje IS 'Pitesamisk navn';
COMMENT ON COLUMN industries.name_smj IS 'Lulesamisk navn';
COMMENT ON COLUMN industries.name_se IS 'Nordsamisk navn';

COMMENT ON COLUMN platform_admins.role IS 'owner (kan ikke slettes/endres) eller admin';

COMMENT ON COLUMN products.search_tags IS 'Synonymer og søkeord for bedre søk (ikke synlig for brukere)';
COMMENT ON COLUMN services.search_tags IS 'Synonymer og søkeord for bedre søk (ikke synlig for brukere)';

-- ============================================
-- MIGRATION COMPLETE
-- ============================================

-- To seed platform owner, run this manually with correct user_id:
-- INSERT INTO platform_admins (user_id, role, is_active)
-- VALUES ('[REPLACE_WITH_USER_ID]', 'owner', TRUE)
-- ON CONFLICT (user_id) DO NOTHING;
